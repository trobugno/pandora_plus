## .github/workflows/run-tests.yml
name: üß™ Run GDUnit Tests

on:
  
  # Esegui su pull request
  pull_request:
    branches: [ main, master, develop ]
  
  # Permetti esecuzione manuale
  workflow_dispatch:

# Permessi necessari
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  run-tests:
    name: Run Tests on Godot ${{ matrix.godot-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        godot-version: ['4.5']
    
    steps:
      # 1. Checkout del repository
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      # 2. Setup cache per Godot
      - name: üíæ Cache Godot
        uses: actions/cache@v3
        with:
          path: |
            ~/.local/share/godot
            ~/Library/Application Support/Godot
          key: godot-${{ matrix.godot-version }}-${{ runner.os }}
      
      # 3. Download e setup Godot
      - name: üéÆ Setup Godot ${{ matrix.godot-version }}
        uses: chickensoft-games/setup-godot@v1
        with:
          version: ${{ matrix.godot-version }}
          use-dotnet: false
      
      # 4. Verifica installazione Godot
      - name: ‚úÖ Verify Godot Installation
        run: |
          godot --version
          godot --headless --version
      
      # 5. Setup GDUnit (se non √® gi√† nell'addon)
      - name: üì¶ Setup GDUnit4
        run: |
          # Opzione A: Se GDUnit √® gi√† nel progetto come addon, skip questo step
          # Opzione B: Se vuoi installarlo al volo, usa questo:
          echo "GDUnit4 should be included in addons/ folder"
          # mkdir -p addons
          # cd addons
          # git clone https://github.com/MikeSchulze/gdUnit4.git
      
      # 6. Import del progetto Godot
      - name: üìÇ Import Godot Project
        run: |
          godot --headless --editor --quit
        timeout-minutes: 2
      
      # 7. Esegui i test GDUnit
      - name: üß™ Run GDUnit Tests
        run: |
          godot --headless --script addons/gdUnit4/bin/GdUnitCmdTool.gd \
            --add="res://tests" \
            --continue \
            --verbose \
            --report \
            --report-path="./reports" \
            --quit-on-finish
        timeout-minutes: 10
      
      # 8. Upload dei report
      - name: üìä Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-godot-${{ matrix.godot-version }}
          path: reports/
          retention-days: 7
      
      # 9. Pubblica risultati come commento su PR
      - name: üí¨ Publish Test Results
        if: always() && github.event_name == 'pull_request'
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/**/*.xml
          check_name: Test Results (Godot ${{ matrix.godot-version }})
      
      # 10. Fail se ci sono test falliti
      - name: ‚ùå Check Test Results
        if: always()
        run: |
          if [ -f reports/summary.json ]; then
            FAILURES=$(cat reports/summary.json | grep -o '"failures":[0-9]*' | grep -o '[0-9]*')
            if [ "$FAILURES" -gt 0 ]; then
              echo "::error::$FAILURES test(s) failed!"
              exit 1
            fi
          fi

  # Job separato per verificare code quality
  code-quality:
    name: üîç Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üéÆ Setup Godot
        uses: chickensoft-games/setup-godot@v1
        with:
          version: '4.5'
      
      # Verifica che non ci siano errori di script
      - name: üîç Check for Script Errors
        run: |
          godot --headless --check-only --script-errors-stop addons/pandora_plus/ --quit
      
      # Opzionale: Verifica file formatting
      - name: üìù Check GDScript Formatting
        run: |
          # Installa gdtoolkit se vuoi formattare il codice
          # pip install gdtoolkit
          # gdformat --check addons/pandora_plus/
          echo "Formatting check (optional)"

  # Job per verificare che la documentazione sia aggiornata
  docs-check:
    name: üìö Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: ‚úÖ Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "::error::README.md is missing!"
            exit 1
          fi
      
      - name: ‚úÖ Check docs folder
        run: |
          if [ ! -d docs ]; then
            echo "::warning::docs/ folder is missing"
          fi
      
      - name: ‚úÖ Verify all examples have README
        run: |
          for dir in examples/*/; do
            if [ ! -f "${dir}README.md" ]; then
              echo "::warning::${dir} is missing README.md"
            fi
          done
